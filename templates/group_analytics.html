<!-- templates/group_analytics.html -->
{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º{% endblock %}

{% block content %}
<style>
    body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(-45deg, #003366, #004c99, #0073e6, #003366);
        background-size: 400% 400%;
        animation: gradientShift 10s ease infinite;
        font-family: "Segoe UI", sans-serif;
        color: #fff;
        position: relative;
        overflow-x: hidden;
    }

    /* –¢–µ–∫—Å—Ç –Ω–∞ –∑–∞–¥–Ω–µ–º —Ñ–æ–Ω–µ */
    body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, transparent 95%, rgba(255,255,255,0.1) 100%),
            linear-gradient(0deg, transparent 95%, rgba(255,255,255,0.1) 100%),
            radial-gradient(circle at 20% 80%, rgba(255,255,255,0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 0%, transparent 50%);
        background-size: 50px 50px, 50px 50px, 500px 500px, 500px 500px;
        opacity: 0.4;
        pointer-events: none;
        z-index: 1;
    }

    @media (max-width: 768px) {
        body::before {
            background-size: 30px 30px, 30px 30px, 300px 300px, 300px 300px;
        }
    }

    .top-line {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(255,255,255,0.6) 20%, 
            rgba(255,255,255,0.8) 50%, 
            rgba(255,255,255,0.6) 80%, 
            transparent 100%);
        z-index: 2;
    }

    .bottom-line {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(255,255,255,0.6) 20%, 
            rgba(255,255,255,0.8) 50%, 
            rgba(255,255,255,0.6) 80%, 
            transparent 100%);
        z-index: 2;
    }

    header {
        background: rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(8px);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 3;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    header img {
        height: 50px;
        transition: transform 0.3s ease;
    }

    header img:hover {
        transform: scale(1.05);
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .header-title {
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .btn-nav {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-nav:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        color: white;
        text-decoration: none;
    }

    .main-content {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        position: relative;
        z-index: 3;
    }

    .dashboard-container {
        width: 100%;
        max-width: 1200px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        color: #000;
        animation: fadeIn 0.8s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 4;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .form-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid rgba(0, 51, 102, 0.2);
        position: relative;
    }

    .form-header::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 25%;
        right: 25%;
        height: 2px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            #003366 20%, 
            #0073e6 50%, 
            #003366 80%, 
            transparent 100%);
        z-index: 1;
    }

    .form-title {
        color: #003366;
        font-weight: 700;
        margin-bottom: 1rem;
        font-size: 1.8rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .form-subtitle {
        color: #666;
        font-size: 1rem;
        max-width: 500px;
        margin: 0 auto;
    }

    .form-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 51, 102, 0.1);
        position: relative;
        overflow: hidden;
        margin-bottom: 1.5rem;
        animation: slideIn 0.6s ease;
    }

    .form-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
            #003366 0%, 
            #0073e6 50%, 
            #003366 100%);
        z-index: 1;
    }

    .analytics-form-container {
        background: rgba(0, 51, 102, 0.05);
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 51, 102, 0.1);
        animation: fadeIn 0.8s ease;
    }

    .analytics-form-container .row {
        animation: slideIn 0.6s ease;
    }

    .form-label {
        color: #003366;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .form-select, .form-control {
        border: 2px solid rgba(0, 51, 102, 0.2);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-select:focus, .form-control:focus {
        border-color: #0073e6;
        box-shadow: 0 0 0 0.25rem rgba(0, 115, 230, 0.25);
        transform: translateY(-2px);
    }

    .btn-analytics {
        background: linear-gradient(135deg, #003366, #0073e6);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        text-decoration: none;
        text-align: center;
        min-width: 180px;
        height: 100%;
        animation: pulse 2s infinite;
    }

    .btn-analytics:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 51, 102, 0.4);
        background: linear-gradient(135deg, #0073e6, #003366);
        color: white;
        text-decoration: none;
        animation: none;
    }

    .btn-analytics:active {
        transform: translateY(-1px);
    }

    .btn-analytics::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .btn-analytics:hover::after {
        left: 100%;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 2rem 0;
    }

    .stat-box {
        background: linear-gradient(135deg, rgba(0, 51, 102, 0.9), rgba(0, 115, 230, 0.9));
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
        color: white;
        box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
        animation: slideIn 0.5s ease forwards;
        opacity: 0;
        transform: translateY(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 51, 102, 0.4);
    }

    .stat-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(255, 255, 255, 0.8) 50%, 
            transparent 100%);
        z-index: 1;
    }

    .stat-box:nth-child(1) { animation-delay: 0.1s; }
    .stat-box:nth-child(2) { animation-delay: 0.2s; }
    .stat-box:nth-child(3) { animation-delay: 0.3s; }
    .stat-box:nth-child(4) { animation-delay: 0.4s; }

    .stat-box.total {
        background: linear-gradient(135deg, rgba(0, 51, 102, 0.9), rgba(0, 115, 230, 0.9));
    }

    .stat-box.excused {
        background: linear-gradient(135deg, rgba(32, 201, 151, 0.9), rgba(25, 135, 84, 0.9));
    }

    .stat-box.unexcused {
        background: linear-gradient(135deg, rgba(253, 126, 20, 0.9), rgba(220, 53, 69, 0.9));
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .stat-box:hover .stat-value {
        transform: scale(1.1);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        margin-top: 2rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.7s ease;
    }

    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }

    table {
        margin: 0;
        width: 100%;
    }

    thead {
        background: linear-gradient(90deg, #003366, #0073e6);
        color: white;
    }

    th {
        padding: 1rem !important;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
    }

    th:hover {
        background: linear-gradient(90deg, #002244, #0055aa);
        transform: translateY(-2px);
    }

    td {
        padding: 1rem !important;
        vertical-align: middle;
        transition: all 0.3s ease;
    }

    tbody tr {
        animation: slideIn 0.5s ease forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    tbody tr:nth-child(1) { animation-delay: 0.1s; }
    tbody tr:nth-child(2) { animation-delay: 0.2s; }
    tbody tr:nth-child(3) { animation-delay: 0.3s; }
    tbody tr:nth-child(4) { animation-delay: 0.4s; }
    tbody tr:nth-child(5) { animation-delay: 0.5s; }
    tbody tr:nth-child(6) { animation-delay: 0.6s; }
    tbody tr:nth-child(7) { animation-delay: 0.7s; }
    tbody tr:nth-child(8) { animation-delay: 0.8s; }

    tbody tr:hover {
        background-color: rgba(0, 51, 102, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .text-success { 
        color: #198754 !important; 
        font-weight: 600;
    }

    .text-danger { 
        color: #dc3545 !important; 
        font-weight: 600;
    }

    .badge-stat {
        font-size: 0.9em;
        padding: 5px 10px;
        border-radius: 20px;
        color: white;
        font-weight: 600;
        transition: transform 0.2s ease;
    }

    .badge-stat:hover {
        transform: scale(1.05);
    }

    .badge-total {
        background-color: #003366;
    }

    .badge-excused {
        background-color: #20c997;
    }

    .badge-unexcused {
        background-color: #fd7e14;
    }

    .alert {
        border-radius: 10px;
        border: none;
        margin-bottom: 1.5rem;
        animation: fadeIn 0.5s ease;
    }

    .alert-info {
        background: rgba(33, 150, 243, 0.1);
        color: #1565c0;
        border-left: 4px solid #2196f3;
    }

    .action-buttons-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid rgba(0, 51, 102, 0.1);
        animation: fadeIn 1s ease;
    }

    .left-button {
        display: flex;
        justify-content: flex-start;
        flex: 1;
    }

    .btn-action {
        background: linear-gradient(135deg, #003366, #0073e6);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        text-decoration: none;
        text-align: center;
        min-width: 180px;
        justify-content: center;
    }

    .btn-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 51, 102, 0.4);
        background: linear-gradient(135deg, #0073e6, #003366);
        color: white;
        text-decoration: none;
    }

    .btn-action:active {
        transform: translateY(-1px);
    }

    .btn-back {
        background: linear-gradient(135deg, #6c757d, #495057);
    }

    .btn-back:hover {
        background: linear-gradient(135deg, #495057, #6c757d);
    }

    .btn-export {
        background: linear-gradient(135deg, #20c997, #198754);
    }

    .btn-export:hover {
        background: linear-gradient(135deg, #198754, #20c997);
    }

    .footer {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        text-align: center;
        padding: 20px;
        width: 100%;
        background: rgba(0, 0, 0, 0.2);
        margin-top: auto;
        position: relative;
        z-index: 3;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .footer-text {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
    }

    .group-name {
        font-weight: 600;
        color: #003366;
        font-size: 1.2rem;
        text-align: center;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: linear-gradient(90deg, transparent, rgba(0, 51, 102, 0.1), transparent);
        border-radius: 10px;
        animation: slideIn 0.5s ease;
    }

    .period-info {
        text-align: center;
        color: #666;
        margin-bottom: 1.5rem;
        font-style: italic;
        animation: fadeIn 0.7s ease;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
    th.sorted-asc::after {
        content: " ‚Üë";
        opacity: 0.8;
        font-size: 0.9em;
    }

    th.sorted-desc::after {
        content: " ‚Üì";
        opacity: 0.8;
        font-size: 0.9em;
    }

    .no-data-message {
        text-align: center;
        padding: 3rem;
        color: #666;
        animation: fadeIn 0.5s ease;
    }

    .no-data-message h5 {
        color: #003366;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 1.5rem;
            margin: 1rem;
        }
        
        header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
            padding: 1rem;
        }
        
        .logo-container {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .header-actions {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .form-card {
            padding: 1.5rem;
        }
        
        .form-title {
            font-size: 1.5rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .stat-value {
            font-size: 2rem;
        }
        
        .btn-analytics {
            width: 100%;
            min-width: auto;
        }
        
        .action-buttons-container {
            flex-direction: column;
            gap: 1rem;
        }
        
        .left-button, .right-buttons {
            width: 100%;
            justify-content: center;
        }
        
        .btn-action {
            width: 100%;
            min-width: auto;
        }
        
        th, td {
            padding: 0.75rem !important;
            font-size: 0.9rem;
        }
        
        .analytics-form-container .row {
            flex-direction: column;
        }
        
        .analytics-form-container .col-md-4,
        .analytics-form-container .col-md-3,
        .analytics-form-container .col-md-2 {
            width: 100%;
            margin-bottom: 1rem;
        }
    }

    @media (max-width: 576px) {
        .right-buttons {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-action {
            width: 100%;
        }
        
        .stats-grid {
            flex-direction: column;
            gap: 20px;
        }
        
        .form-title {
            font-size: 1.3rem;
        }
    }
</style>

<!-- –í–µ—Ä—Ö–Ω—è—è –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ª–∏–Ω–∏—è -->
<div class="top-line"></div>

<!-- –®–∞–ø–∫–∞ -->
<header>
    <div class="logo-container">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="–†–ò–ù–•">
        <h5 class="header-title">–§–∏–Ω–∞–Ω—Å–æ–≤–æ-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–æ–ª–ª–µ–¥–∂ (–†–ò–ù–•)</h5>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('auth.logout') }}" class="btn-nav">
            <span class="icon"></span>
            –í—ã–π—Ç–∏
        </a>
    </div>
</header>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
<div class="main-content">
    <div class="dashboard-container">
        <div class="form-header">
            <h1 class="form-title">
                üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º
            </h1>
            <p class="form-subtitle">
                –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ –∏ –ø–µ—Ä–∏–æ–¥—É
            </p>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, msg in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center">
                            <span class="icon me-2">
                                {% if category == 'success' %}‚úÖ
                                {% elif category == 'danger' %}‚ùå
                                {% elif category == 'warning' %}‚ö†Ô∏è
                                {% else %}‚ÑπÔ∏è
                                {% endif %}
                            </span>
                            <div>{{ msg }}</div>
                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="form-card">
            <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã –∏ –ø–µ—Ä–∏–æ–¥–∞ -->
            <div class="analytics-form-container">
                <form method="POST" action="{{ url_for('dashboard.group_analytics') }}">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="group_id" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É:</label>
                            <select class="form-select" id="group_id" name="group_id" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
                                {% for group in groups %}
                                    <option value="{{ group.id }}" {% if selected_group and selected_group.id == group.id %}selected{% endif %}>
                                        {{ group.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ request.form.get('start_date', '') }}" required>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ request.form.get('end_date', '') }}" required>
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn-analytics w-100">
                                <span class="icon">üîç</span>
                                –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            {% if selected_group %}
                <div class="group-name">
                    üìä –ê–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã: <strong>{{ selected_group.name }}</strong>
                </div>
                
                {% if request.form.get('start_date') and request.form.get('end_date') %}
                    <div class="period-info">
                        –ü–µ—Ä–∏–æ–¥: —Å {{ request.form.get('start_date') }} –ø–æ {{ request.form.get('end_date') }}
                    </div>
                {% endif %}
                
                {% if absences_data %}
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—Ä—É–ø–ø–µ -->
                    <div class="stats-grid">
                        <div class="stat-box total">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤</div>
                            <div class="stat-value">{{ absences_data.total }}</div>
                        </div>
                        
                        <div class="stat-box excused">
                            <div class="stat-icon">‚úÖ</div>
                            <div class="stat-label">–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–µ</div>
                            <div class="stat-value">{{ absences_data.total_excused }}</div>
                        </div>
                        
                        <div class="stat-box unexcused">
                            <div class="stat-icon">‚ùå</div>
                            <div class="stat-label">–ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–µ</div>
                            <div class="stat-value">{{ absences_data.total_unexcused }}</div>
                        </div>
                    </div>

                    {% if student_stats %}
                    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle" id="analyticsTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable(0, 'string')">–°—Ç—É–¥–µ–Ω—Ç</th>
                                        <th class="text-center" onclick="sortTable(1, 'number')">–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤</th>
                                        <th class="text-center" onclick="sortTable(2, 'number')">–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–µ</th>
                                        <th class="text-center" onclick="sortTable(3, 'number')">–ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–µ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in student_stats %}
                                    <tr>
                                        <td>{{ stat.student }}</td>
                                        <td class="text-center">
                                            <span class="badge badge-stat badge-total">{{ stat.total }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-stat badge-excused">{{ stat.excused }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-stat badge-unexcused">{{ stat.unexcused }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                {% else %}
                    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö -->
                    <div class="no-data-message">
                        <h5>üì≠ –ü—Ä–æ–ø—É—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
                        <p>–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤ –≥—Ä—É–ø–ø–µ "{{ selected_group.name }}" –ø—Ä–æ–ø—É—Å–∫–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.</p>
                        <div class="mt-3">
                            <span class="icon">üí°</span>
                            <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏.</small>
                        </div>
                    </div>
                {% endif %}

            {% elif request.method == 'POST' and not selected_group %}
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã –±–µ–∑ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã -->
                <div class="alert alert-info text-center">
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="icon me-2">‚ÑπÔ∏è</span>
                        <div>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="action-buttons-container">
            <div class="left-button">
                <!-- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –¢–µ–ø–µ—Ä—å –≤–µ–¥–µ—Ç –Ω–∞ admin_dashboard -->
                <a href="{{ url_for('dashboard.admin_dashboard') }}" class="btn-action btn-back">
                    <span class="icon">‚¨Ö</span>
                    –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                </a>
            </div>
            <div class="right-buttons">
                {% if selected_group and absences_data and student_stats %}
                <button type="button" class="btn-action btn-export" onclick="exportAnalyticsData()">
                    <span class="icon">üì•</span>
                    –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ù–∏–∂–Ω—è—è –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ª–∏–Ω–∏—è -->
<div class="bottom-line"></div>

<!-- –§—É—Ç–µ—Ä -->
<div class="footer">
    <div class="footer-text">
        ¬© 2025–≥. –§–∏–Ω–∞–Ω—Å–æ–≤–æ-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–æ–ª–ª–µ–¥–∂ (–†–ò–ù–•)
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    function sortTable(columnIndex, type = 'string') {
        const table = document.getElementById('analyticsTable');
        if (!table) return;
        
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const headerCell = table.querySelector(`th:nth-child(${columnIndex + 1})`);
        const isAscending = !headerCell.classList.contains('sorted-asc');
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–æ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        table.querySelectorAll('th').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        if (isAscending) {
            headerCell.classList.add('sorted-asc');
        } else {
            headerCell.classList.add('sorted-desc');
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏
        rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();
            
            if (type === 'number') {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –±–µ–π–¥–∂–∏)
                aValue = parseInt(aValue) || parseInt(a.cells[columnIndex].querySelector('.badge')?.textContent || '0') || 0;
                bValue = parseInt(bValue) || parseInt(b.cells[columnIndex].querySelector('.badge')?.textContent || '0') || 0;
            }
            
            if (isAscending) {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });
        
        // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫
        rows.forEach((row, index) => {
            setTimeout(() => {
                row.style.transition = 'all 0.3s ease';
                row.style.transform = 'translateY(0)';
                tbody.appendChild(row);
            }, index * 30);
        });
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    function exportAnalyticsData() {
        const table = document.getElementById('analyticsTable');
        if (!table) {
            showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }
        
        let csv = [];
        const rows = table.querySelectorAll('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const row = [], cols = rows[i].querySelectorAll('td, th');
            
            for (let j = 0; j < cols.length; j++) {
                // –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏ HTML —Ç–µ–≥–∏
                let data = cols[j].innerText.replace(/[\u{1F600}-\u{1F64F}]/gu, '').trim();
                data = data.replace(/\n/g, ' ');
                row.push('"' + data + '"');
            }
            
            csv.push(row.join(';'));
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ –∏ –ø–µ—Ä–∏–æ–¥–µ
        const groupName = document.querySelector('.group-name strong')?.textContent || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞';
        const periodInfo = document.querySelector('.period-info')?.textContent || '–ù–µ —É–∫–∞–∑–∞–Ω –ø–µ—Ä–∏–æ–¥';
        
        csv.unshift(`"–ì—Ä—É–ø–ø–∞: ${groupName}"`);
        csv.unshift(`"${periodInfo}"`);
        csv.unshift('"–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏"');
        
        // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + csv.join('\n');
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        
        const fileName = `–∞–Ω–∞–ª–∏—Ç–∏–∫–∞_${groupName.replace(/[^–∞-—è–ê-–Ø0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
        link.setAttribute("download", fileName);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showAlert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV —Ñ–∞–π–ª', 'success');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <span class="icon me-2">${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                <div>${message}</div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–æ–π
        const formCard = document.querySelector('.form-card');
        if (formCard) {
            formCard.parentNode.insertBefore(alertDiv, formCard);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    const bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }
            }, 5000);
        }
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        const dashboardContainer = document.querySelector('.dashboard-container');
        if (dashboardContainer) {
            dashboardContainer.style.opacity = '0';
            dashboardContainer.style.transform = 'translateY(30px) scale(0.95)';
            
            setTimeout(() => {
                dashboardContainer.style.transition = 'all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
                dashboardContainer.style.opacity = '1';
                dashboardContainer.style.transform = 'translateY(0) scale(1)';
            }, 200);
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const statBoxes = document.querySelectorAll('.stat-box');
        statBoxes.forEach((box, index) => {
            setTimeout(() => {
                box.style.opacity = '1';
                box.style.transform = 'translateY(0)';
            }, 400 + (index * 100));
        });
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach((row, index) => {
            setTimeout(() => {
                row.style.opacity = '1';
                row.style.transform = 'translateY(0)';
            }, 600 + (index * 50));
        });
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
        const buttons = document.querySelectorAll('.btn-action, .btn-analytics');
        buttons.forEach((btn, index) => {
            btn.style.opacity = '0';
            btn.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                btn.style.transition = 'all 0.5s ease';
                btn.style.opacity = '1';
                btn.style.transform = 'translateY(0)';
            }, 700 + (index * 100));
        });
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        const formContainer = document.querySelector('.analytics-form-container');
        if (formContainer) {
            formContainer.style.opacity = '0';
            setTimeout(() => {
                formContainer.style.transition = 'all 0.5s ease';
                formContainer.style.opacity = '1';
            }, 300);
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç—ã
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        if (startDateInput && !startDateInput.value) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const firstDayOfMonth = new Date();
            firstDayOfMonth.setDate(1);
            startDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
        }
        
        if (endDateInput && !endDateInput.value) {
            endDateInput.value = today;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', function() {
                if (endDateInput.value && this.value > endDateInput.value) {
                    endDateInput.value = this.value;
                }
            });
            
            endDateInput.addEventListener('change', function() {
                if (startDateInput.value && this.value < startDateInput.value) {
                    startDateInput.value = this.value;
                }
            });
        }
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    document.getElementById('group_id')?.addEventListener('change', function() {
        if (this.value && document.getElementById('start_date')?.value && document.getElementById('end_date')?.value) {
            this.form.submit();
        }
    });
</script>
{% endblock %}